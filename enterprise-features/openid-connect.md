# OpenID Connect

## What is OpenID Connect?

OpenID Connect is an identity layer built on top of OAuth2 it allows third-party applications to get basic information about your profile and verify your identity. Its purpose is to give you one login for multiple sites. You're probably familiar with it if you used **Login with Google**. For example, if you click Login with Google you'll be redirected to the Google page with verify form that you allow some website to get information from your profile for example email, name, etc.

## How Defguard implements OpenID?

As an identity provider one of our core features is Login with Defguard which allows you to log into other websites using your Defguard account so you don't have to care about multiple passwords and leaks. At this point you may have concern and ask is it safe? Yes, it's completely safe cause all information third party app will receive is the information that you allowed on redirect page. These information then are sent to third party app as IDToken which is basically JSON Web Token with additional claims like first name or email. Your password isn't send in any step of this.

## Defguard OpenID flow

![OpenID flow](../in-depth/puml/openid-flow.svg)

## How to enable login with Defguard using OpenID?

### Client creation

To enable login with other app first you need to add it as new OpenID client.
To do it navigate to OpenID Apps on the left side navigation then click Add new button.

![OpenID add client form](../.gitbook/assets/OpenIDForm.png)

Here are explained inputs

**Name** Name of your client
**Redirect URI** URL on which user will be redirected with generated PKCE code example("https://myapp.com/redirect_uri")
**Scopes** Scopes which your client will be using

After creating your client you can click on it on list and be redirected to detailed client page with it unique Client ID and Client secret codes.

**Client ID** is a public identifier for apps. Something like unique login so we can verify app URL matches it's Client ID.
**Client Secret** Only known for authorization server(Defguard) and the applications as we using

Setup on authorization app if you want to login with Defguard.

### Authentication request

Set up your login with Defguard button to redirect to authorization endpoint which is `https://defguard.company.net/openid/authorize?`

Below is sample authentication request which your app should do on Login with Defguard button

```
http://defguard.company.net/openid/authorize?
client_id=<YOUR_CLIENT_ID> // Generated by defguard available on app detail page
&redirect_uri=<YOUR_REDIRECT_URI>  //Url on which user with code will be redirected
&scope=openid%20profile%20phone%20email // available scopes
&response_type=code // Currently only supported response is code
&state=<YOUR_STATE> // State to returned on redirect uri to verify request comes with Defguard
```

#### Notes:

1. Client id and secret is generated by Defguard after creating your app you can see it on app detail page
2. **Scope** must contain OpenID
3. Available scopes are profile(all available info from user profile) phone and email
4. Currently only supported **response_type** is **code**.
5. Redirect URI is URL on which user will be redirected with generated PKCE code (Redirect URI must match URI declared on client creation otherwise error will be returned)

#### Successful authentication response

```
HTTP/1.1 302 Found

Location: <YOUR_REDIRECT_URI>?
code=SplxlOBeZQQYbYS6WxSbIA
&state=af0ifjsldkj
```

### Exchange code for ID Token

After receiving code from previous step you need to exchange it for token
on token endpoint defguard.company.net/api/v1/openid/token

Request Header and URL:

```
Content-Type: application/x-www-form-urlencoded
POST defguard.company.net/api/v1/openid/token
```

Request body:
Need to be form encoded

```
grant_type=authorization_code
&redirect_uri=<YOUR_REDIRECT_URI>
&code=<CODE_RECEIVED_IN_PREVIOUS_STEP>
```

#### Note:

1. Currently only supported **grant_type** is authorization_code
2. Code is your PKCE code received in previous step

#### Successful Token Response

```
  HTTP/1.1 200 OK
  Content-Type: application/json
  Cache-Control: no-store
  Pragma: no-cache

  {
   "id_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjFlOWdkazcifQ.ewogImlzc
     yI6ICJodHRwOi8vc2VydmVyLmV4YW1wbGUuY29tIiwKICJzdWIiOiAiMjQ4Mjg5
     NzYxMDAxIiwKICJhdWQiOiAiczZCaGRSa3F0MyIsCiAibm9uY2UiOiAibi0wUzZ
     fV3pBMk1qIiwKICJleHAiOiAxMzExMjgxOTcwLAogImlhdCI6IDEzMTEyODA5Nz
     AKfQ.ggW8hZ1EuVLuxNuuIJKX_V8a_OMXzR0EHR9R6jgdqrOOF4daGU96Sr_P6q
     Jp6IcmD3HP99Obi1PRs-cwh3LO-p146waJ8IhehcwL7F09JdijmBqkvPeB2T9CJ
     NqeGpe-gccMg4vfKjkM8FcGvnzZUN4_KSP0aAp1tOJ1zZwgjxqGByKHiOtX7Tpd
     QyHE5lcMiKPXfEIQILVq0pc_E2DzL7emopWoaoZTF_m0_N0YzFC6g6EJbOEoRoS
     K5hoDalrcvRYLSrQAZZKflyuVCyixEoV9GfNQC3_osjzw2PAithfubEEBLuVVk4
     XUVrWOLrLl0nx7RkKU8NXNHq-rvKMzqg"
  }
```

#### Note:

1. As we using HS256 algorithm ID Token is signed using your app Client Secret

#### Authorized apps:

Every user that used Login with Defguard option can see in his profile name of every authorized app.
If you revoke app then you will have to click allow on form with permissions again.

# OpenID clients

Below you can find tutorials how to configure login with defguard in popular clients.

## Grafana

### Add grafana app on defguard

First, go to the defguard OpenID tab and click add new app button.

1. Add the name Grafana
2. Redirect Url add `https://<grafana domain>/login/generic_oauth`
   where <grafana domain> is the address of your grafana instance.
3. Select the below scopes

-   OpenID
-   Profile
-   Email
Then add your app.
After successfully adding your app you can see it in the OpenID apps list. When you click on it you will be redirected to the client 
details page.
From this page copy Client ID and Client secret values for later.

### Grafana setup

1. Open your [grafana config](https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/#config-file-locations)
which is located in `/etc/grafana/grafana.ini` if you're using linux if you're using other operating system see link above.

2. In auth section of your configuration file append the template from below and fill it with corresponding values.

```
#################################### Auth Defguard ##########################
[auth.generic_oauth]
name = Defguard
icon = signin
enabled = true
client_id = <YOUR_APP_CLIENT_ID>  # from defguard page
client_secret = <YOUR_APP_CLIENT_SECRET> # from defguard page
scopes = openid profile email
empty_scopes = false
auth_url = https://<your_defguards_instance>/api/v1/oauth/authorize
token_url = https://<your_defguard_instance>/api/v1/oauth/token
api_url = https://<your_defguard_instance>/oauth/userinfo
allow_sign_up = true
```

3. Restart your grafana server using `systemctl restart grafana-server`
4. Then on login, you'll see the `Sign-in defguard button`

## Portainer

### Add Portainer app on defguard

First, go to the defguard OpenID tab and click add new app button.

1. Add the name Portainer
2. Redirect Url add `https://yourportainer.com`
   where yourpotainer.com is the address of your portainer instance.
3. Select the below scopes

-   OpenID
-   Profile
-   Email
    Then add your app.
    After successfully adding your app you can see it in the OpenID apps list. When you click on it you will be redirected to the client details page.
    From this page copy Client ID and Client secret values for later.

### Portainer configuration

When you login to portainer go to **Settings -> Authentication**

On this page select:
Authentication method: OAuth

#### Provider

Select **Custom**

#### OAuth Configuration

-   **Client ID** -> Client ID from defguard available on client details page.
-   **Client secret** -> Client secret from defguard available on client details page.
-   **Authorization URL** -> https://<YOUR_DEFGUARD_INSTANCE>/api/v1/oauth/authorize
-   **Access token URL** -> https://<YOUR_DEFGUARD_INSTANCE>/api/v1/oauth/token
-   **Resource URL** -> https://<YOUR_DEFGUARD_INSTANCE>/api/v1/oauth/userinfo
-   **Redirect URL** -> https://<YOUR_PORTAINER_URL>
-   **User identifier** -> sub
-   **Scopes** -> `openid email profile` **Note** must be spaces separated as in this example

## Django Rest Framework React app

In this example we show you how to get user data from Defguard to create user session in your django app.

### Configuring client

As in all of the steps above first step is to add your app in Defguard OpenID apps.

### Django setup

1. Install [Authlib](https://docs.authlib.org/en/latest/)
2. Create new app and name it oauth using
   `python3 manage.py createapp oauth`
3. In newly created oauth app go to views.py file

First step is to create our defguard client configuration

```
# Create defguard oauth client
oauth = OAuth()
defguard = oauth.register(
    name="defguard",
    client_id=os.getenv("DEFGUARD_CLIENT_ID", "DEFGUARD_CLIENT_ID"),
    client_secret=os.getenv("DEFGUARD_CLIENT_SECRET", "DEFGUARD_CLIENT_SECRET"),
    access_token_url=os.getenv("DEFGUARD_ACCESS_TOKEN_URL", "http://defguard.com/api/v1/oauth/token"),
    access_token_params=None,
    authorize_url=os.getenv("DEFGUARD_AUTHORIZE_URL", "http://defguard.com/v1/oauth/authorize"),
    api_base_url=os.getenv("DEFGUARD_API_BASE_URL", "http://defguard.com/api/v1/oauth/userinfo"),
    client_kwargs={"scope": os.getenv("DEFGUARD_SCOPE", "openid email profile")},
    server_metadata_url=os.getenv("DEFGUARD_METADATA_URL", "http://defguard.com/.well-known/openid-configuration"),
)
```

Remember to add appropriate values to match your defguard instance.

In the next step we have to create login endpoint which will redirect users from our app to Defguard consent page.

```
def defguard_login(request):
    """Build a full authorize callback uri."""
    redirect_uri = request.build_absolute_uri(EXAMPLE_DEFGUARD_REDIRECT_URL)
    return oauth.defguard.authorize_redirect(request, redirect_uri)
```

**Note** `EXAMPLE_DEFGUARD_REDIRECT_URL` is url for our authorize endpoint which we discuss in the next step.
We recommend to add it to `settings.py` file like this:

```
# Our app url to consume defguard token
EXAMPLE_DEFGUARD_REDIRECT_URL = os.getenv('EXAMPLE_DEFGUARD_REDIRECT_URL', 'http://localhost:3000/api/oauth/redirect')
```

our endpoint to consume tokens will look like this
as our app uses [Django Rest token authentication](https://www.django-rest-framework.org/api-guide/authentication/#tokenauthentication), we need to extract user data from the token received from defguard
and transform it to a Django Rest token.
at the end of the function, we login user to a session so we can get it later from our react app and at the end, we returns
redirect to the frontend main page.

```
def defguard_authorize(request):
    """Exchange authorization code for token."""
    token = oauth.defguard.authorize_access_token(request)
    resp = oauth.defguard.get("userinfo", token=token)
    resp.raise_for_status()
    profile = resp.json()
    user = User.objects.filter(username=profile["sub"])[0]
    if not user:
        user = User.objects.create_user(
            is_active=True,
            username=profile["sub"],
            email=profile["email"],
            first_name=profile["given_name"],
            last_name=profile["family_name"],
        )
    auth.login(request, user)
    # return redirect to frontend
    return redirect("/")
```

Our session endpoint from which our React app can receive token.

```
@api_view(["GET"])
@authentication_classes([SessionAuthentication])
def get_me(request):
    """Return token based on user in session."""
    user = request.user
    token, _ = Token.objects.get_or_create(user=user)
    return Response({"token": token.key}, status=status.HTTP_200_OK)
```

and our logout endpoint where we remove token from session

```
@api_view(["GET"])
def logout(request):
    """Logout user."""
    auth.logout(request)
    data = {
        "message": "You have successfully logged out.",
    }
    return Response(data, status=status.HTTP_200_OK)
```

Then we need to add our views to `oauth/urls.py` file.

```
from django.urls import path

from apps.oauth.views import defguard_authorize, defguard_login, get_me, logout

urlpatterns = [
    path('defguard-login/', defguard_login),
    path('redirect/', defguard_authorize),
    path('me/', get_me),
    path('logout/', logout),
]
```

Thats it on the backend site if we don't want to hold users in our database and only create session for them.
But if you want to create users you need to call `user.save()` in `defguard_authorize` function we recommend to set
some strong password for this users like uuid or base64 they won't need it anyway because they login through defguard.

### React app

On your login page add login with defguard button which `onClick` will redirect to our `defguard-login/` endpoint.

```
<button onClick={() => (window.location.href = `${API_URL}/oauth/defguard-login/`)}>
  Login with Defguard
</button>
```

**Note** `API_URL`is url of your django backend api
When the user clicks on button he will be redirected to the defguard page where he has to login with his defguard account
and permit our app to collect his profile data.

After redirect you can call `me/` endpoint in your react app to receive auth token.
